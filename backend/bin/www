#!/usr/bin/env node
const { port } = require('../config');
const app = require('../app');

const httpServer = require('http').createServer(app);
const db = require('../db/models');
const io = require('socket.io')(httpServer);

// Check the database connection before starting the app
db.sequelize
  .authenticate()
  .then(() => {
    console.log('Database connection success! Sequelize is ready to use...');
    //run when client connects


    io.on('connection', socket => {
      console.log('socket connection');

      //this is to a single client (current user)
      socket.emit('message', 'Welcome to Shrewdness')

      //broadcast (to other users) when a user connections
      //to everyone except user
      socket.broadcast.emit('message', 'User has joined the chat room');

      //broadcasts to everyone, including the current user
      io.emit()

      // Runs when a client disconnects (yes it needs 
      //to be inside of the connection)
      socket.on('disconnect', () => {
        io.emit('message', 'user has left the chat')
      })


    });

    // Start listening for connections
    httpServer.listen(port, () => console.log(`Listening on port ${port}...`));
  })
  .catch((err) => {
    console.log('Database connection failure.');
    console.error(err);
  });